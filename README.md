# Dobot Color Pick‑and‑Place Demo

## 概要

本リポジトリは **Dobot Magician**（または互換機）のPython SDKを用いて，カメラ映像内の **赤色／青色** オブジェクトを認識し，マウスクリックで指示した座標へロボットアームを移動させて吸着把持・配置を行うインタラクティブデモです。

### システム構成

* **ビジョン** ― OpenCVでHSVしきい値処理を行い，色領域の重心を取得。
* **ロボット制御** ― Dobot DLLをラップし，非同期コマンドキューで安全に実行。
* **キャリブレーション** ― 画像座標系とアーム座標系を4点対応からホモグラフィ行列で変換。

#### 主な構成要素

* 画像座標系 → ロボット座標系の変換
* クリックによる座標指定移動
* 赤色または青色領域検出による座標指定
* サクションカップ操作（物体の吸着・離脱）
* 非同期（`threading`）によるロボットコマンド実行

---

## 1. 動かし方 (Quick Start)

### 1‑1. 依存パッケージをインストール

```bash
pip install opencv-python numpy keyboard
```

### 1‑2. Dobot SDK を配置

公式SDKから取得した **`DobotDll.dll`** と **`DobotDllType.py`** を `lib/`フォルダに置きます。

### 1‑3. 実行

```bash
python main.py
```

### 1‑4. 操作方法

| 操作        | 動作                 |
| --------- | ------------------ |
| **左クリック** | 吸着オン/オフで把持 ↔ 配置を切替 |
| **Q キー**  | プログラム終了            |

> **メモ** : 初回起動時はロボットが原点復帰した後にカメラウィンドウが開きます。赤・青の物体を画角に置くと自動で検出されます。

---

## 2. コード解説 (Key Modules)

### 2‑1. ファイル一覧

| ファイル                 | 主な役割                                                                              |
| -------------------- | --------------------------------------------------------------------------------- |
| **`main.py`**        | アプリケーション本体。カメラループ、マウスイベント、座標変換、Dobot へのコマンド送信を統括。                                 |
| **`dobot_utils.py`** | Dobot DLL ラッパ。接続初期化 `init_dobot()`、座標移動 `move_ptp()`、半径制限 `clamp_radius()` などを提供。 |
| **`image_utils.py`** | OpenCV ベースの色領域検出。`detect_color_region()` が HSV しきい値 → モーメント重心を返す。                 |

### 2‑2. 制御フロー概要

```
Camera Frame
   ↓  (HSV Threshold)
Centroid
   ↓  (Homography image→robot)
Radius Clamp
   ↓  (Dobot PTP Queue)
Async Execution
```

* **左クリック時のロジック**
  *吸着オフ* → 色領域へ下降・吸着
  *吸着オン* → クリック点へ移動・リリース
* **パラメータ**
  Z高さ : `z_grab = -60`, `z_place = -55`
  半径制限 : `R_min`, `R_max`
  いずれもソース内定数で変更可能です。

---

## 3. 詳細コード解説 (In‑Depth Walk‑through)

### 3‑1. `main.py`

| 関数                                  | 役割                                                                                                                           | 主要引数             | 返り値            |
| ----------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- | ---------------- | -------------- |
| `init()`                            | システムセットアップ：Dobot 接続・カメラ ID・キャリブレーション点・ホモグラフィ行列をまとめて生成し `dobot_handle` に格納                                                    | –                | `dobot_handle` |
| `image_to_robot_coords(dh, px, py)` | 画像座標 → アーム XY 座標への射影（`cv2.perspectiveTransform()` 使用）                                                                        | `dh`, `px`, `py` | `(x, y)`       |
| `check_arm_cord4calibration(dh)`    | **アーム側 4 点キャリブレーション** を手動取得                                                                                                  | `dh`             | –              |
| `check_image_cord4calibration(dh)`  | **画像側 4 点キャリブレーション** をクリックで取得                                                                                                | `dh`             | –              |
| `test_homography_matrix(dh)`        | クリック点へ実際にロボットを動かし，ホモグラフィ精度を検証                                                                                                | `dh`             | –              |
| `main(dh)`                          | 本体ループ：<br>1. フレーム取得→`detect_color_region()`<br>2. 左クリックで把持/配置をトグル<br>3. 座標変換 + 半径制限<br>4. `SetPTPCmd()` → `exec_dobot_cmd()` | `dh`             | –              |

> **イベントコールバック** : `click_event()` が `nonlocal` 変数を捕捉し，直前に検出した重心を優先把持します。

#### 3‑1‑1. 状態遷移図（吸着トグル）

```
[suction OFF] --click--> 吸着→上昇→状態 = ON
[suction  ON] --click--> 下降→リリース→状態 = OFF
```

### 3‑2. `dobot_utils.py`

| 関数                                     | 役割                                                                                                                                              | 補足                                  |
| -------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------- |
| `init_dobot()`                         | DLL ロード → USB 接続 (`115200 bps`) → `Dobot_Handle` を生成                                                                                            | 接続結果は `CON_STR` で表示                 |
| `destory_dobot(dh)`                    | Dobot 切断                                                                                                                                        | 終了時に呼び出し推奨                          |
| `clamp_radius(dh, x, y, r_min, r_max)` | アーム水平面での安全半径制限                                                                                                                                  | `r_min/r_max` 省略時は `dh.R_min/R_max` |
| `get_position(dh)`                     | 現在の XYZR を取得（`GetPose`）                                                                                                                         | デバッグ用                               |
| `exec_dobot_cmd(dh, lastIndex)`        | **非同期 PTP キュー完了待ち**<br>1. スレッド join→list から除去<br>2. `SetQueuedCmdStartExec`<br>3. `GetQueuedCmdCurrentIndex` ポーリング<br>4. `SetQueuedCmdStopExec` | 100 msごとに位置を表示                      |
| `move2home_pos(dh)`                    | ホームポジション復帰 (`SetHOMECmd()`)                                                                                                                     | キャリブレーション前に推奨                       |

> **スレッドモデル** : PTP コマンド列は GUI ループと並列。`threading.Thread` + `exec_dobot_cmd()` で Python 側をブロックしません。

### 3‑3. `image_utils.py`

| 関数                                      | 役割                                    | 詳細処理                                                                                                                                                                                  |
| --------------------------------------- | ------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `detect_color_region(img, color='red')` | 画像中の赤 or 青領域をマスクし **重心 (cX, cY)** を返す | 1. `cv2.cvtColor` で HSV 変換<br>2. 赤: H∈\[0,10]∪\[170,180]，青: H∈\[85,130]<br>3. `erode → dilate` でノイズ除去<br>4. `cv2.moments` で重心計算 (検出なし時は (0,0))<br>5. デバッグ用に `Region` / `Mask` ウィンドウ表示 |

---

## 4. カスタマイズのヒント

| 項目        | 方法                                                                    |
| --------- | --------------------------------------------------------------------- |
| **高さ・半径** | `main.py` の `z_grab / z_place`，`dobot_utils.py` の `R_min / R_max` を変更 |
| **色の追加**  | `detect_color_region()` に HSV 範囲を追記し，引数 `color` に新ラベルを渡す              |
| **カメラ切替** | `dobot_handle.camera_id`（既定 `1`）を `0` / `2` … に変更                     |

---

